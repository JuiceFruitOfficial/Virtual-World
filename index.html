<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JuiceFruit virtual world</title>
    <style>
        
    </style>
    <script src="3d.js"></script>
    <script src="projector.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="input.js"></script>
    <script src="devs.js"></script>
    <script src="world.js"></script>
    <script src="animations.js"></script>
    <script src="rules.js"></script>
    <script src="security/index.js"></script>
</head>
<body>
    
    <div id="setup">
        <div>
            <h1>Welcome!</h1>
            <span class="tab1" onclick="showlogin()">Log in</span><span class="tab1" onclick="showregister()">Register</span>
            <div id="login">
                <h2>Log in</h2>
                <div>
                <span>Username: </span><input type="text" id="username1">
            <span>Password: </span><input type="password" id="password1">
            
            
                </div>
            <label>
                <span>Remember me</span><input type="checkbox" id="remember" checked="true">
            </label>
            <p style="color: red" id="loginmessage"></p>
            <br>
            <button onclick="login()">Log in</button>
            </div>
            <div id="register">

            <h2>Create an account</h2>
            <p>Please fill the registeration form below.</p>
            <div style="text-align: left;">
            <span>Username: </span><input type="text" id="username">
            <span>Password: </span><input type="password" id="password">
            <span>Password again: </span><input type="password" id="password2">
            <span>Your date of birth: </span><input type="date" id="birthday">
            <span>Your age (yes we ask this too): </span><input type="number" id="age">
            <span>Installation type: </span>
            <select>
                <option value="corner"><strong>Corner mode: </strong>The device will be used in a corner and <strong>the world will be projected to that corner</strong></option>
            </select>
            </div>
            <br>
            <h2>The rules and terms of usage</h2>
            <label>
                <span>I have read and I accept the <span style="color: blue" onclick="alert(termsofusage)">terms of usage</span> and <span style="color: blue" onclick="alert(rules)">the rules of the JuiceFruit Virtual World</span></span> <input id="termcheck" type="checkbox">
            </label><br>
            <p style="color: red" id="registermessage"></p>
            <button onclick="register()">Submit</button>
        </div>
        </div>
    </div>
    <div id="maindiv">
    <div id="testdiv2"></div>
    <div id="start">
        <h1>Hello and welcome to JuiceFruit virtual world 2.0!</h1>
        <p id="loadinfo1"></p>
        <div id="loadbar1" class="loadbar"></div>
        <button onclick="start()">Enter as normal user</button>
        <button onclick="devground()">Developer playground</button>
    </div>
    <div id="testdiv"></div>
    <audio id="audio1"></audio>
    <h1 id="timer1">10</h1>
    <div id="container">
        
        
        <div id="target1" class="target" width="150" height="150"></div>
        <div id="target2" class="target" width="150" height="150"></div>
    </div>
    <div id="characterdiv">
        <h1>Your character</h1>
        
    </div>
    <div id="characterinfo">
        <h1>Stats</h1>
        <br>
        <p>Level:</p>
        <div id="leveldiv" style="width: 5px;"></div>
        <p>Intelligence:</p>
        <div id="intelligencelevel"></div>
        <p>Strength:</p>
        <div id="strengthlevel"></div>
        <p>Environment friendliness:</p>
        <div id="eflevel"></div>
        
    </div>
</div>

<div id="textonly2">
    <h1 id="textonly"></h1>
</div>

<div id="loadimg2">
    <img id="loadimg">
</div>
    <audio id="audio2"></audio>
    <video autoplay="true" id="videoElement" controls="">
        
        </video>
        <canvas id="canvas">
            
        </canvas>
        <canvas id="lefthand" width="150" height="150"></canvas>
        <canvas id="righthand" height="150" width="150"></canvas>
        <div hidden>
            <canvas id="bgcanvas"></canvas>
        
        </div>

        <div id="devdiv">
            <div id="programs">
                <h1>Test programs</h1>
            </div>
            <div id="console">
            <textarea id="consolelog"></textarea>
            <input type="text" id="command" placeholder="Type command here..." onkeydown="devc(event)"><button>Enter</button>
        </div>
        <div id="toolbar"><button onclick="show3d()">Show/hide 3D</button><button onclick="showtests()">Show/hide tests</button><button onclick="showconsole()">Show/hide console</button><button onclick="changeprojector()">Change projector mode</button><button onclick="balltest()">Ball test</button><button onclick="resolutionTest(3,3)">Test 3x3 resolution</button><button onclick="closedev()">Close devtools</button></div>
 <div id="blockdiv">
        <div id="front-wall"></div>
        <div id="left-wall"></div>
        <div id="right-wall"></div>
        <div id="back-wall"></div>
        <div id="ceiling"></div>
    </div>
    </div>
   
        <div id="resdiv">
        </div>

        <div id="sky">
            <div class="cloud" style="left: 40px;"></div><div style="right: 40px" class="cloud"></div>
            <div class="sun"></div>
        </div>
        <div id="projectordiv">

        </div>
        <button id="devbtn" onclick="devground()">Open devtools</button>
        <div id="errordiv">

        </div>

        <div style="display: none;">
            <iframe name="iframe1" id="iframe1" src="about:blank"></iframe>
            <form id="form1" action="register.php" method="POST" target="iframe1">
                <textarea name="data" id="formdata1"></textarea>
            </form>
        </div>
    <script>

        //The remember me value on login
        if (localStorage.remember) {
            if (localStorage.remember=="yes") {
            //Try to login with last used password and user
            var password=localStorage.lastpass
    var username=localStorage.lastuser
    if (strcheck(username+password)) {
        document.getElementById("form1").action="login.php"
    document.getElementById("formdata1").value=username+";"+password;
    document.getElementById("form1").submit()
    }else{
        document.getElementById("loginmessage").innerHTML="Wrong password"
    }}
        }else{
            localStorage.remember="no"
        }

        if (localStorage.lastpass) {

        }else{
            localStorage.lastpass=""
        }
        if (localStorage.lastuser) {

        }else{
            localStorage.lastuser=""
        }
        
        window.onerror = function(msg, url, linenumber) {
    document.getElementById("errordiv").style.display="block"
    document.getElementById("errordiv").innerHTML='<h1>ERROR</h1>Message: '+msg+'\n<br>URL: '+url+'\n<br>Line Number: '+linenumber;
}
        var projectorElements=[]
var projectorIds=[]
var projectorcount=0
        var version=0.0002
        var testpr=["Microsoft logo"]
        var testpr2=["printImg(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAALVBMVEXyUCJ/ugAApO//uQD////yTh/zVy2EvRYWp/D/uxbyTBvzXziJvyQkq/D/viRJQpTmAAABDUlEQVR4nO3PyRHCQBAEwRHo5vDfXD1ZC5oYyHKgIqtSLev8aZtixYCEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhIQdhUuq81vCNdZjED63WDX/eoT9I+wfYf8I+0fYv9pjvYbt+4hVt1j7IDzusQgJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQn/WXgB6/1wCkBWrdwAAAAASUVORK5CYII=)"]
        var vaihe=0
        var vaiheet=3
        var detecteddata=false
        var setup=0;
var range=100
var video = document.querySelector("#videoElement");
        function loadinfo(text) {
            vaihe++
        document.getElementById("loadinfo1").innerHTML=text + ", " + Math.floor(vaihe/vaiheet * 100) + "% done"
        document.getElementById("loadbar1").style.width=Math.floor(window.innerWidth * (vaihe/vaiheet)) + "px"
        }
        loadinfo("Starting virtual world")
        loadinfo("Calibrating device")
        loadinfo("Starting system")

        function start() {
            document.getElementById("start").style.display="none"
            //document.getElementById("testdiv").style.display="block"
            playaudio("Calibration.m4a")
            document.getElementById("videoElement").play()
            setTimeout(camerasetup, 4000)
        }
        function camerasetup() {
            playaudio("Camera setup.m4a")
            document.body.style.backgroundColor="white"
            setup=1
            document.getElementById("videoElement").style.visibility="visible"
            //Make hand targets
            document.getElementById("target1").style.left=(window.innerWidth / 2 + document.getElementById("canvas").offsetWidth / 4) + "px"
            document.getElementById("target2").style.left=(window.innerWidth / 2 - document.getElementById("canvas").offsetWidth / 4 - 160) + "px"
            document.getElementById("target2").style.display="block"
            document.getElementById("target1").style.display="block"
           
            //Set the right size
            document.getElementById("bgcanvas").width=document.getElementById("canvas").offsetWidth
            document.getElementById("bgcanvas").height=document.getElementById("canvas").offsetHeight
            //Clone background 
            var ctx1=document.getElementById("canvas").getContext("2d")
            var ctx2=document.getElementById("bgcanvas").getContext("2d")
            var imgData = ctx1.getImageData(0, 0, document.getElementById("canvas").offsetWidth, document.getElementById("canvas").offsetWidth);
            ctx2.putImageData(imgData, 0, 0);
        }

        function charactersetup() {
            document.getElementById("lefthand").style.display="none"
            document.getElementById("righthand").style.display="none"
            document.getElementById("target1").style.display="none"
            document.getElementById("target2").style.display="none"
            document.getElementById("videoElement").style.visibility="hidden"
            document.getElementById("characterdiv").style.display="block"
            document.getElementById("characterinfo").style.display="block"
            projecttext("Your character", true)
        }

        function loading() {
            document.getElementById("testdiv2").style.display="block"
            document.body.style.backgroundColor="black"
        }
        function playaudio(name) {
            document.getElementById("audio1").src=name
            document.getElementById("audio1").play()
            
        }

        
var previouspixel=[]
function scanvideo() {      
    //Set the canvas width and height
      document.getElementById("canvas").width=document.getElementById("videoElement").offsetWidth
document.getElementById("canvas").height=document.getElementById("videoElement").offsetHeight
    
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");
    var img = document.getElementById("videoElement");
   ctx.drawImage(img, 0, 0);
   var imgData=ctx.getImageData(0,0,canvas.width,canvas.height)
   
   //Loop through every tenth pixel
   detecteddata=false
    for (i=0; i < canvas.height;i+=0.5) {
        var pixel=imgData.data[((i + 0.25) * canvas.width).toFixed(0)] + imgData.data[((i + 0.25) * canvas.width + 1).toFixed(0)] + imgData.data[((i + 0.25) * canvas.width+2).toFixed(0)]
        if (previouspixel.length < i) {
           previouspixel.push(pixel)
        }
        if (previouspixel[i]==0) {
           previouspixel[i]=pixel
        }
        if (pixel > previouspixel[i] + range) {
            if (detecteddata==false) {
                movement(i)
                        }
        }else if (pixel < previouspixel[i] - range) {
               if (detecteddata==false) {
                movement(i)
                      }
           }else{
            
        }
        if (detecteddata==true) {
            //alert("Pixel num:" + i + "\nPixel data:" + pixel + "\npreviouspixel:" +previouspixel[i] + "\nData length:" + imgData.data.length)
        }
       
        previouspixel[i]=pixel
   }
}
function timeup() {
    if (setup==1) {
        if (Number(document.getElementById("timer1").innerHTML)==0) {
            setup=2

            //Capture hands
            var ctx1=document.getElementById("canvas").getContext("2d")
            var ctx2=document.getElementById("righthand").getContext("2d")
            var imgData = ctx1.getImageData(document.getElementById("canvas").offsetWidth / 4-150, document.getElementById("canvas").offsetHeight / 2 - 160, 150, 150);
            ctx2.putImageData(imgData, 0, 0);
            var imgData = ctx1.getImageData(document.getElementById("canvas").offsetWidth / 4 * 3, document.getElementById("canvas").offsetHeight / 2 - 160, 150, 150);
            var ctx2=document.getElementById("lefthand").getContext("2d")
            ctx2.putImageData(imgData, 0, 0);
            document.getElementById("righthand").style.display="block"
            document.getElementById("lefthand").style.display="block"
            setTimeout(scan3dspace, 3000)
        }else{
            document.getElementById("timer1").innerHTML=Number(document.getElementById("timer1").innerHTML)-1
        }
        
    }
}
function movement(num) {
    
}

function devground() {
    //document.getElementById("start").style.display="none"
    document.getElementById("devdiv").style.display="block"
    document.getElementById("devbtn").style.display="none"
    document.getElementById("programs").innerHTML="<h1>Test programs</h1>"
    for (var i=0; i < testpr.length; i++) {
        var newelement=document.createElement("div")
        var newspan=document.createElement("span")
        newspan.innerHTML=testpr[i]
        newelement.appendChild(newspan)
        var newbtn=document.createElement("button")
        newbtn.innerHTML="Edit"
        newbtn.setAttribute("onclick", "editpr(" + i + ")")
        newelement.appendChild(newbtn)
        var newbtn=document.createElement("button")
        newbtn.innerHTML="Run"
        newbtn.setAttribute("onclick", "runpr(" + i + ")")
        newelement.appendChild(newbtn)
        document.getElementById("programs").appendChild(newelement)
    }
}
setInterval(timeup, 1000)
//Login
function showregister() {
    document.getElementById("register").style.display="block"
    document.getElementById("login").style.display="none"
}

function showlogin() {
    document.getElementById("register").style.display="none"
    document.getElementById("login").style.display="block"
}

function login() {
    var password=document.getElementById("password1").value
    var username=document.getElementById("username1").value
    if (strcheck(username+password)) {
        document.getElementById("form1").action="login.php"
    document.getElementById("formdata1").value=encrypt(username)+";"+encrypt(password);
    document.getElementById("form1").submit()
    localStorage.lastuser=encrypt(username);
    localStorage.lastpass=encrypt(password);
    }else{
        document.getElementById("loginmessage").innerHTML="Wrong password"
    }
    
}
function register() {
    var password=document.getElementById("password").value
    var password1=document.getElementById("password2").value
    var username=document.getElementById("username").value
    var date=document.getElementById("birthday").value.split("-")
    var age=Number(document.getElementById("age").value)
    var create=true
    var message=""
    if (password=="") {
        create=false
        message=message+"<br>The password is empty"
    }
    if (username=="") {
        create=false
        message=message+"<br>The username is empty"
    }
    if (password != password1) {
        message=message+"<br>The passwords don't mach"
        create=false
    }
    var dateobj=new Date(Number(date[0]),Number(date[1]),Number(date[2]))
    var date2=new Date()
    var years=date2.getFullYear()-dateobj.getFullYear()
    if (years > age) {
        message=message+"<br>The birthday and age don't mach"
        create=false
    }
    if (years+1 < age) {
        message=message+"<br>The birthday and age don't mach"
        create=false
    }

    if (document.getElementById("termcheck").checked==false) {
        message=message+"<br>You must accept the terms of service and rules!"
        create=false
    }
    if (strcheck(password+username)==false) {
        message=message+"<br>The username and password fields can only contain following characters <strong>abcdefghijklmnopqrstuvwxyz1234567890!@#€%&/?:-_,*</strong>"
        create=false
    }
    //Create account
    if (create==true) {
        document.getElementById("form1").action="register.php"
        document.getElementById("formdata1").value=encrypt(username)+";"+encrypt(password)+";"+encrypt(document.getElementById("birthday").value)+";";
        document.getElementById("form1").submit()
        startworld()
    }else{
        document.getElementById("registermessage").innerHTML=message
    }

}

function startworld() {
    document.getElementById("setup").style.display="none"
    document.getElementById("start").style.display="block"
    playaudio("Welcome.m4a")

    //Start camera and microphone
    if (navigator.mediaDevices.getUserMedia) {
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(function (stream) {
      video.srcObject = stream;
//start the scanning loop
setInterval(scanvideo, 500)
    })
    .catch(function (err0r) {
      console.log("Something went wrong!");
    });
}

if (navigator.mediaDevices.getUserMedia) {
  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(function (stream) {
      document.getElementById("audio2").srcObject = stream;
    })
    .catch(function (err0r) {
      console.log("Something went wrong!");
    });
}
}

function receiveMessage(event) {
    console.log(event)
    var data=event.data.split(";")
    if (data[0]=="logged in") {
        if (data[1]==encrypt(document.getElementById("username1").value)) {
            if (document.getElementById("remember").checked==true) {
                localStorage.remember="yes"
            }else{
                localStorage.remember="no"
            }
            startworld()
        }
    }else if (data=="nopass") {
        document.getElementById("loginmessage").innerHTML="Wrong password"
    }
}
window.addEventListener("message", receiveMessage, false);

    </script>
</body>
</html>