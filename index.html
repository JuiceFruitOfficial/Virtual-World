<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JuiceFruit virtual world</title>
    <script src="data.js"></script>
    <script src="crafting.js"></script>
    <script src="inventory.js"></script>
    <script src="projector.js"></script>
    <link rel="stylesheet" id="styles1" href="styles.css">
    <script src="input.js"></script>
    <script src="devs.js"></script>
    <script src="world.js"></script>
    <script src="animations.js"></script>
    <script src="rules.js"></script>
    <script src="security/index.js"></script>
    <script src="characters.js"></script>
    <script src="communication.js"></script>
    <link rel="stylesheet" href="images/icons.css"></link>
    
    <script src="html5-qrcode.min.js"></script>
    <script src="davidshimjs-qrcodejs-04f46c6/qrcode.min.js"></script>
    <script src="jfos.js"></script>
    <script src="settings.js"></script>
</head>
<body onresize="resized()" onkeydown="keyInput(event)" onkeyup="keyup(event)" onmousemove="mousemoved(event)">
    <div id="warning" class="modal">
        <h1>Warning!</h1>
        <p>You are currently trying to enter a beta version of our virtual world! It will be a place where everyone can be whatever they want. They can work there (for real money), play, meet eachoter... actually, the only limit is your imagination! Sounds cool, right?<br><br> Well that is what it will be some day...<br><br>Currently it is a very unstable early version containing tests and many, many bugs... <br><br>To make the virtual world working nicely, we need <strong>your help</strong>. Yes, you can help us! And we are not talking only about programmers, we are talking about everyone. You can help with things you are good at! You can help us make the world better, design something, just throw some good ideas at us, just about anything!</p>
        <br><br><h2>If you want to help us...</h2>
        <p>You can</p><br>
        <a href="mailto:juicefruitsystem@gmail.com"><button>Email us</button></a> <a href="https://www.instagram.com/juicefruitofficial/"><button>DM us on Instagram (and a follow would be nice too)</button></a> 
        <br>
        <button onclick="nowarning()">Continue to the virtual world</button>
    </div>
    <div id="setup">
       
        </div>
    </div>
    <div id="maindiv">
    <div id="testdiv2"></div>
    <div id="start">
        <img src="images/logo.png">
        <h2>JuiceFruit Virtual World</h2>
        
        <button onclick="start()">Play</button>
        <div id="bouncyball1"></div>
    </div>
    
    <div id="testdiv"></div>
    <audio id="audio1"></audio>
    <audio id="audio3" loop="true"></audio>
    
    <div id="allowmedia" class="modal">
        <h1>To continue, you have to allow access for</h1>
        <br>
        <br>
        <div class="l1">
            <span class="circlebox"><span class="microphone"></span></span>
        </div>
        <div class="r1">
            <span class="circlebox"><span class="cameraicon"></span></span>
        </div>
        
        <br>
        <div id="characterdiv">
            <h1>Select character</h1>
            <div>
                
            </div>
            <div>
                
            </div>
            <div>
                
            </div>
        </div>
        <div id="createcharacter" class="modal">
            <div id="charcolors">
           <div>
               <p>Character name</p>
               <input type="text" id="charname" value="Untitled character">
               <p>Skin color</p>
               <input type="color" id="skincolor" value="#ffa493" onchange="updatechar1()">
           <p>Hair color</p>
           <input type="color" value="#a74c00" id="haircolor" onchange="updatechar1()">
           <p>Eye color</p>
           <input type="color" id="eyecolor" value="#000000" onchange="updatechar1()">
           <p>Favourite color</p>
           <input type="color" value="#000dff" id="favcolor" onchange="updatechar1()">
           <p>Age:</p>
           <select id="charage1">
               <option value="baby">Baby</option>
               <option value="adult">Adult</option>
           </select><br>
           <div style="text-align: center;">
               <br>
               <div id="createcharbtn" class="circlebtn"><a><span>CREATE</span></a></div>
           </div>
           
           </div>
           <div id="previewchar0">
               
           </div>
       </div>
       
        
    </div>
    <span class="circlebtn" id="charselectbtn" onclick="inputsettings()"><br>Continue</span>
    <div id="container">
        
        
        <div id="target1" class="target" width="150" height="150"></div>
        <div id="target2" class="target" width="150" height="150"></div>
    </div>
   
</div>
<div id="inputsettings" class="modal">
    <h1><span>How</span> <span>do</span> <span>you</span> <span>want</span> <span>to</span> <span>play?</span></h1>
    <div>
        <h1>Input</h1>
        <div id="mouseinput" class="selected">
            <span>B</span>
            <span class="mouse"></span>
            <p>Mouse and keyboard</p>
            <span class="gear" onclick="keysettings()">&#9881;</span>
        </div>
        <h2>Output</h2>
        <div id="screen1" class="selected">
            <span class="screen"></span>
            <p>Screen 1</p>
        </div>
    </div>
    <div id="keysettings" class="popup">
        <h1>Keyboard control settings</h1>
        <div>
            <span>Move forward</span>
            <span class="key">W</span>
            <span>Move backward</span>
            <span class="key">S</span>
            <span>Move left</span>
            <span class="key">A</span>
            <span>Move right</span>
            <span class="key">D</span>
        </div>
    </div>
    <button onclick="startplaying()">Continue</button>
</div>


        <div id="devdiv">
            <div id="programs">
                <h1>Test programs</h1>
            </div>
            <div id="console">
            <textarea id="consolelog"></textarea>
            <input type="text" id="command" placeholder="Type command here..." onkeydown="devc(event)"><button>Enter</button>
        </div>
    </div>
   
        <div id="resdiv">
        </div>
        
        <div id="qrcode"></div>
        <div id="errordiv">

        </div>

        
        
        <div id="loaddiv" class="modal">
            <div class="preloader">
                <div class="description">
                    <h1 id="description_text">Loading error</h1>
                </div>
                <div class="loader"></div>
            </div>
        </div>
        
        <div id="world" class="modal">
            
            <div id="worlddiv">

            </div>
            <div id="gamearea" onmousedown="if (playing=true) {placeitem(event)}">
        
            </div>
            <div id="enterplace"><span class="key">T</span><h1>Enter</h1></div>
            <div id="player" class="player">
                <div class="head">
        
                </div>
                <div class="hand righthand" id="righthand">
                    <div class="spellstick" style="display: none;"></div>
                </div>
                <div class="hand lefthand" id="lefthand">
                    <div class="spellstick" style="transform: rotate(-30deg); right: 20px;"></div>
                </div>
        
                <div class="leg rightleg" id="rightleg">
        
                </div>
                <div class="leg leftleg" id="leftleg">
        
                </div>
                <div class="body">
        
                </div>
            </div>
            <div id="fade"></div>
            <div id="dark"></div>
            <div id="tabs">
                    <span onclick="showitems()">Items</span>
                    <span onclick="showspells()">Spells</span>
                </div>
            
            <div id="inventory2">
                <div id="leafstorm" class="weak">
                    <div class="leaf"></div>
                </div>
                <p id="leafstorm1">LeafStorm</p>
                <div id="fireball" class="weak">
                    <div class="fireball"></div>
                </div>
                <p id="fireball1">Fire Ball</p>
            </div>
            
            <div id="carbar">
                <div id="carwheel" class="steeringwheel"></div>
            </div>
            <div id="infodiv">
                <p id="position1"></p>
                <p id="rotation"></p>
                <p id="compass1"></p>
            </div>
            <div id="user">
                <div>
                    <img src="images/nerdclan.png" width="75px" height="75px">
                </div>
                <div>
                    <p id="usernameinfo"></p>
                    <div id="hp"></div>
                    <p>Money: <span id="money"></span><span class="coinicon"></span></p>
                    <span class="hearticon"></span><div id="hpbar"></div>
                </div>
                

            </div>
            <div id="profilediv" class="modal">
                <h1 id="profilename1"></h1>
                <div id="levelbar"></div>
                <div>
                    <span>Friends</span><span>Followers</span><span>Uploads</span>
                    <span id="friendsinfo"></span><span id="followersinfo"></span><span id="uploadsinfo"></span>
                </div>
                <div>
                    <span class="send"></span><span class="follow"></span><span class="addfriend"></span><span class="website"></span>
                </div>
                <div id="uploads">

                </div>
            </div>
            <div id="quickstuff">
                <span class="map"></span>
                <span class="backbag"></span>
                <span>Map</span>
                <span>Inventory</span>
                <span class="key">M</span>
                <span class="key">E</span>
            </div>
            <div id="hotbar">
                <div></div>
                <div></div>
                <div></div>
            </div>
            <div id="actions"></div>
            <div id="crafting">

            </div>
            <div id="inventory" class="popup">
                <div>
                    <h1>Items</h1>
                    <div id="itemlist">
                        <div><span class="pickaxe"></span><span>Pickaxe</span><span>5</span></div>
                    </div>
                </div>
                <div id="storagepoints"></div>
                <div id="iteminfo">
                    <h1 id="itemname"></h1><img id="itemimg">
                    <div style="text-align: left; margin-left: 170px">
                        <p>Durability: <span id="itemdurability"></span></p>
                    <p>Damage: <span id="itemdamage"></span></p>
                    <p>Range: <span id="itemrange"></span></p>
                    <p>Size: <span id="itemspace"></span></p>
                    </div>
                    
                    <div id="buttondiv">
                        <span class="key">1</span>
                        <span class="key">2</span>
                        <span class="key">3</span>
                        <button>Add to hotbar slot 1</button>
                    <button>Add to hotbar slot 2</button>
                    <button>Add to hotbar slot 3</button>
                    </div>
                    
                </div>
            </div>
            <div id="guidePanel"></div>
            <div id="textbox">
                <h1 id="textheader"></h1>
                <p id="textboxtext"></p>
                <div id="buttondiv1"><button id="textbtn1"></button>
                <button id="textbtn2"></button></div>
                
            </div>
            <div id="mouse"></div>
            <div id="notificationdiv"></div>
            <div id="jfos" class="modal">
                <div id="appbar">
                    <div>
                        <img src="images/jfnetwork.png" style="width: 100%;">
                    </div>
                    
                </div>
                <div id="addressbar">
                    <input type="text" id="address" placeholder="JuiceFruit Network address here..."> 
                </div>
                <div id="window">
                    
                </div>
            </div>
        </div>
        <div style="display: none;" id="camera">
        
        </div>
        <audio id="audio2"></audio>
    <video autoplay="true" id="videoElement" controls="">
    <script>
        var gnum=[]
        var unfloored=[]
        var unfloored2=[]
        var leafstorm=0
        var health= 250
        var stonespiritreload=0
        var animationlist=[]
        var enemies=[]
    var playerx=0
    var playery=0
    var playerz=0
    var playerrotate=0
    var unloaded=[]
    var interval;
    var recharching=false
    var gameobjects=[]
    var selecteditem=""
    var enterplace="false"
    var gameobjects=[]
    var lastchunk=""
        window.onerror = function(msg, url, linenumber) {
    document.getElementById("errordiv").style.display="block"
    document.getElementById("errordiv").innerHTML='<h1>ERROR</h1>Message: '+msg+'\n<br>URL: '+url+'\n<br>Line Number: '+linenumber;
}
        var projectorElements=[]
var projectorIds=[]
var projectorcount=0
        var version=0.0006
        var testpr=["Microsoft logo"]
        var testpr2=["printImg(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAALVBMVEXyUCJ/ugAApO//uQD////yTh/zVy2EvRYWp/D/uxbyTBvzXziJvyQkq/D/viRJQpTmAAABDUlEQVR4nO3PyRHCQBAEwRHo5vDfXD1ZC5oYyHKgIqtSLev8aZtixYCEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhIQdhUuq81vCNdZjED63WDX/eoT9I+wfYf8I+0fYv9pjvYbt+4hVt1j7IDzusQgJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQn/WXgB6/1wCkBWrdwAAAAASUVORK5CYII=)"]
        var vaihe=0
        var vaiheet=8
        var detecteddata=false
        var setup=0;
var range=100
var qrcode;

var video = document.querySelector("#videoElement");
        function loadinfo(text) {
            vaihe++
        document.getElementById("description_text").innerHTML=text + ", " + Math.floor(vaihe/vaiheet * 100) + "% done"
        //When all steps are done
        if (vaihe==vaiheet) {
            
            setTimeout(function () {document.getElementById("loaddiv").className="fadeout";startworld()}, 2000)
            setTimeout(function () {
                document.getElementById("loaddiv").style.display="none"
                
            }, 3000)
            
        }
        }
        loadinfo("Calculating time")
        var scripts=document.getElementsByTagName("script")
            vaiheet+=scripts.length
        loadinfo("Checking installation")
        if (localStorage.warning) {

        }else{
            localStorage.warning="true"
        }
        if (localStorage.warning=="true") {
            document.getElementById("warning").style.display="block"
        }
        if (localStorage.inventory1) {
            
        }else{
            localStorage.inventory1="100;iron_pickaxe:1;"
            localStorage.inventory01=encrypt(localStorage.inventory1)
        }
        if (localStorage.inventory2) {
            
        }else{
            localStorage.inventory2="100;iron_pickaxe:1;"
            localStorage.inventory02=encrypt(localStorage.inventory2)
        }
        if (localStorage.inventory3) {
            
        }else{
            localStorage.inventory3="100;iron_pickaxe:1;"
            localStorage.inventory03=encrypt(localStorage.inventory3)
        }
        //The remember me value on login
        if (localStorage.lastpass) {

        }else{
            localStorage.lastpass=""
        }
        if (localStorage.lastuser) {

        }else{
            localStorage.lastuser=""
        }

        loadinfo("Starting virtual world")
        if (localStorage.inventory01==encrypt(localStorage.inventory1)) {
            
        }
        if (localStorage.inventory02==encrypt(localStorage.inventory1)) {
            
        }
        if (localStorage.inventory03==encrypt(localStorage.inventory1)) {
            
        }
        loadinfo("Calibrating device")
        loadinfo("Connecting to JuiceFruit network")
        document.getElementById("styles1").href="styles.css?v=" + new Date().getTime();
        for (var i=0; i < scripts.length; i++) {
            loadinfo("loading scripts") 
            if (scripts[i].hasAttribute("src")) {
                scripts[i].src=scripts[i].src + "?v=" + new Date().getTime();
            }
        }
        loadinfo("Starting 3D-engine")
        
        loadinfo("Connecting to JuiceFruit Network")
        qrcode = new QRCode(document.getElementById("qrcode"), {
    text: "https://juicefruitofficial.github.io/Virtual-World?d=" + deviceId,
    width: 100,
    height: 100,
    colorDark : "#000000",
    colorLight : "#ffffff",
    correctLevel : QRCode.CorrectLevel.H
});
        loadinfo("Starting system")

if (localStorage.lastversion) {
    if (localStorage.lastversion != ""+version) {
        //Show new features
    }
}else{
    localStorage.lastversion=version
}
        var mediaaccess=0
        function start() {
            
            document.getElementById("audio3").pause()
            document.getElementById("start").style.display="none"
            document.getElementById("allowmedia").style.display="block"
            //Start camera and microphone
            //Html5Qrcode.getCameras().then(devices => {
            /**
             * devices would be an array of objects of type:
             * { id: "id", label: "label" }
             */
            /*if (devices && devices.length) {
                var cameraId = devices[0].id;
                const html5QrCode = new Html5Qrcode("camera");
                html5QrCode.start(
                cameraId, 
                {
                    fps: 10,    // Optional frame per seconds for qr code scanning
                    qrbox: 250  // Optional if you want bounded box UI
                },
                qrCodeMessage => {
                    // do something when code is read
                },
                errorMessage => {
                    // parse error, ignore it.
                })
                .catch(err => {
                // Start failed, handle it.
                });
                document.getElementById("allowmedia").getElementsByTagName("div") [1].className=document.getElementById("allowmedia").getElementsByTagName("div") [1].className + " allowed"
                document.getElementById("allowmedia").getElementsByClassName("circlebox") [1].style.boxShadow="0px 0px 50px 5px rgba(55,191,6,1), inset 0px 0px 35px 5px rgba(0,0,0,0.5)"
                mediaaccess++
                if (mediaaccess==2) {
                    charactersetup()
                                    
                    }
            }
            }).catch(err => {
            // handle err
            document.getElementById("allowmedia").getElementsByClassName("circlebox") [1].style.boxShadow="0px 0px 50px 25px rgba(189,0,0,1)"

            });
            

        if (navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(function (stream) {
            document.getElementById("audio2").srcObject = stream;
            document.getElementById("allowmedia").getElementsByClassName("circlebox") [0].style.boxShadow="0px 0px 50px 5px rgba(55,191,6,1), inset 0px 0px 35px 5px rgba(0,0,0,0.5)"
            document.getElementById("allowmedia").getElementsByTagName("div") [0].className=document.getElementById("allowmedia").getElementsByTagName("div") [0].className + " allowed"

            mediaaccess++
                if (mediaaccess==2) {
                    charactersetup()
                    }
        })
            .catch(function (err0r) {
                //Make the shadows
                
                document.getElementById("allowmedia").getElementsByClassName("circlebox") [0].style.boxShadow="0px 0px 50px 25px rgba(189,0,0,1)"
            console.log("Something went wrong!");
            console.log(err0r)
            });
        }*/
            charactersetup()
        }
        

        
var previouspixel=[]
function scanvideo() {      
    //Set the canvas width and height
      document.getElementById("canvas").width=document.getElementById("videoElement").offsetWidth
document.getElementById("canvas").height=document.getElementById("videoElement").offsetHeight
    
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");
    var img = document.getElementById("videoElement");
   ctx.drawImage(img, 0, 0);
   var imgData=ctx.getImageData(0,0,canvas.width,canvas.height)
   
   //Loop through every tenth pixel
   detecteddata=false
    for (i=0; i < canvas.height;i+=0.5) {
        var pixel=imgData.data[((i + 0.25) * canvas.width).toFixed(0)] + imgData.data[((i + 0.25) * canvas.width + 1).toFixed(0)] + imgData.data[((i + 0.25) * canvas.width+2).toFixed(0)]
        if (previouspixel.length < i) {
           previouspixel.push(pixel)
        }
        if (previouspixel[i]==0) {
           previouspixel[i]=pixel
        }
        if (pixel > previouspixel[i] + range) {
            if (detecteddata==false) {
                movement(i)
                        }
        }else if (pixel < previouspixel[i] - range) {
               if (detecteddata==false) {
                movement(i)
                      }
           }else{
            
        }
        if (detecteddata==true) {
            //alert("Pixel num:" + i + "\nPixel data:" + pixel + "\npreviouspixel:" +previouspixel[i] + "\nData length:" + imgData.data.length)
        }
       
        previouspixel[i]=pixel
   }
}
function timeup() {
    if (setup==1) {
        if (Number(document.getElementById("timer1").innerHTML)==0) {
            setup=2
            scanvideo()
            //Capture hands
            var ctx1=document.getElementById("canvas").getContext("2d")
            var ctx2=document.getElementById("righthand").getContext("2d")
            var imgData = ctx1.getImageData(document.getElementById("canvas").offsetWidth / 4-150, document.getElementById("canvas").offsetHeight / 2 - 160, 150, 150);
            ctx2.putImageData(imgData, 0, 0);
            var imgData = ctx1.getImageData(document.getElementById("canvas").offsetWidth / 4 * 3, document.getElementById("canvas").offsetHeight / 2 - 160, 150, 150);
            var ctx2=document.getElementById("lefthand").getContext("2d")
            ctx2.putImageData(imgData, 0, 0);
            document.getElementById("righthand").style.display="block"
            document.getElementById("lefthand").style.display="block"
            setTimeout(scan3dspace, 3000)
        }else{
            document.getElementById("timer1").innerHTML=Number(document.getElementById("timer1").innerHTML)-1
        }
        
    }
}
function movement(num) {
    
}

function devground() {
    //document.getElementById("start").style.display="none"
    document.getElementById("devdiv").style.display="block"
    document.getElementById("devbtn").style.display="none"
    document.getElementById("programs").innerHTML="<h1>Test programs</h1>"
    for (var i=0; i < testpr.length; i++) {
        var newelement=document.createElement("div")
        var newspan=document.createElement("span")
        newspan.innerHTML=testpr[i]
        newelement.appendChild(newspan)
        var newbtn=document.createElement("button")
        newbtn.innerHTML="Edit"
        newbtn.setAttribute("onclick", "editpr(" + i + ")")
        newelement.appendChild(newbtn)
        var newbtn=document.createElement("button")
        newbtn.innerHTML="Run"
        newbtn.setAttribute("onclick", "runpr(" + i + ")")
        newelement.appendChild(newbtn)
        document.getElementById("programs").appendChild(newelement)
    }
}
setInterval(timeup, 1000)
var username;
var password;


function startworld() {
    document.getElementById("setup").style.display="none"
    document.getElementById("start").style.display="block"
    playaudio("Welcome.m4a")
}


function resized() {
   
}
function nowarning() {
    document.getElementById("warning").style.display="none"
    localStorage.warning="false"
}

function bgaudio(name) {
    document.getElementById("audio3").src=name
    document.getElementById("audio3").play()
    document.getElementById("audio3").volume="0.1"
}
bgaudio("audio/loading.m4a")



    </script>
</body>
</html>